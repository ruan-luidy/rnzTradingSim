<UserControl x:Class="rnzTradingSim.Views.CoinDetailView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:hc="https://handyorg.github.io/handycontrol"
             xmlns:vm="clr-namespace:rnzTradingSim.ViewModels"
             xmlns:controls="clr-namespace:rnzTradingSim.Controls"
             d:DataContext="{d:DesignInstance Type=vm:CoinDetailViewModel}"
             mc:Ignorable="d" 
             d:DesignHeight="800" d:DesignWidth="1200"
             Background="{StaticResource DarkBackgroundBrush}">

  <ScrollViewer HorizontalScrollBarVisibility="Disabled" VerticalScrollBarVisibility="Auto">
    <Grid Margin="40">
      <Grid.RowDefinitions>
        <RowDefinition Height="Auto"/>
        <RowDefinition Height="Auto"/>
        <RowDefinition Height="*"/>
      </Grid.RowDefinitions>

      <!-- Loading Indicator -->
      <Grid Grid.Row="0" Grid.RowSpan="3" 
            Visibility="{Binding IsLoading, Converter={StaticResource Boolean2VisibilityConverter}}"
            Background="{DynamicResource DarkOpacityBrush}">
        <hc:LoadingCircle HorizontalAlignment="Center" 
                         VerticalAlignment="Center"
                         IsRunning="{Binding IsLoading}"
                         Style="{StaticResource LoadingCircleLarge}"/>
      </Grid>

      <!-- Header -->
      <Border Grid.Row="0" Style="{StaticResource InfoBoard}" Margin="0,0,0,20">
        <Grid>
          <Grid.ColumnDefinitions>
            <ColumnDefinition Width="Auto"/>
            <ColumnDefinition Width="*"/>
            <ColumnDefinition Width="Auto"/>
          </Grid.ColumnDefinitions>

          <!-- Coin Info -->
          <StackPanel Grid.Column="0" Orientation="Horizontal">
            <controls:CoinIcon CoinSymbol="{Binding CurrentCoin.Symbol}"
                              IconSize="60"
                              Margin="0,0,20,0"/>
            
            <StackPanel VerticalAlignment="Center">
              <TextBlock Text="{Binding CurrentCoin.Name}" 
                        Style="{StaticResource BoardHeaderText}"/>
              <StackPanel Orientation="Horizontal">
                <TextBlock Text="{Binding CurrentCoin.Symbol}"
                          Style="{StaticResource BoardSubheaderText}"/>
                <Border Margin="12,0,0,0" Padding="6,2"
                       Background="#333" CornerRadius="4">
                  <TextBlock Text="{Binding CurrentCoin.MarketCapRank, StringFormat=Rank #{0}}"
                            FontSize="10" FontWeight="Bold"
                            Foreground="{DynamicResource SecondaryTextBrush}"/>
                </Border>
              </StackPanel>
            </StackPanel>
          </StackPanel>

          <!-- Price Info -->
          <StackPanel Grid.Column="1" VerticalAlignment="Center" Margin="40,0">
            <TextBlock Text="{Binding FormattedPrice}" 
                      Style="{StaticResource BoardValueText}"/>
            <TextBlock Text="{Binding FormattedPriceChange}"
                      FontSize="16" FontWeight="SemiBold">
              <TextBlock.Style>
                <Style TargetType="TextBlock">
                  <Style.Triggers>
                    <DataTrigger Binding="{Binding IsPriceUp}" Value="True">
                      <Setter Property="Foreground" Value="#10B981"/>
                    </DataTrigger>
                    <DataTrigger Binding="{Binding IsPriceUp}" Value="False">
                      <Setter Property="Foreground" Value="#EF4444"/>
                    </DataTrigger>
                  </Style.Triggers>
                </Style>
              </TextBlock.Style>
            </TextBlock>
          </StackPanel>

          <!-- Action Buttons -->
          <StackPanel Grid.Column="2" Orientation="Horizontal">
            <Button Content="Refresh" 
                   Command="{Binding RefreshDataCommand}"
                   Style="{StaticResource RugplayButton}"
                   Margin="0,0,12,0"/>
            
            <Button Content="RUG PULL" 
                   Command="{Binding RugPullCommand}"
                   Style="{StaticResource SellButton}"
                   Visibility="{Binding CanRugPull, Converter={StaticResource Boolean2VisibilityConverter}}"/>
          </StackPanel>
        </Grid>
      </Border>

      <!-- Rug Warning -->
      <Border Grid.Row="1" Style="{StaticResource RugWarningBorder}" Margin="0,0,0,20"
              Visibility="{Binding IsRugged, Converter={StaticResource Boolean2VisibilityConverter}}">
        <StackPanel Orientation="Horizontal">
          <TextBlock Text="⚠️" FontSize="20" Margin="0,0,12,0"/>
          <StackPanel>
            <TextBlock Text="THIS COIN HAS BEEN RUGGED!" 
                      FontWeight="Bold" FontSize="16" Foreground="#EF4444"/>
            <TextBlock Text="All liquidity has been stolen. Trading is disabled."
                      FontSize="12" Foreground="#666"/>
          </StackPanel>
        </StackPanel>
      </Border>

      <!-- Main Content -->
      <Grid Grid.Row="2">
        <Grid.ColumnDefinitions>
          <ColumnDefinition Width="1*"/>
          <ColumnDefinition Width="1*"/>
          <ColumnDefinition Width="1*"/>
        </Grid.ColumnDefinitions>

        <!-- Market Stats -->
        <Border Grid.Column="0" Style="{StaticResource InfoBoard}" Margin="0,0,10,0">
          <StackPanel>
            <TextBlock Text="Market Stats" Style="{StaticResource BoardHeaderText}"/>
            
            <!-- Market Cap -->
            <Grid Margin="0,0,0,16">
              <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
              </Grid.ColumnDefinitions>
              <TextBlock Text="Market Cap" Style="{StaticResource BoardSubheaderText}"/>
              <TextBlock Grid.Column="1" Text="{Binding FormattedMarketCap}" 
                        FontWeight="SemiBold"/>
            </Grid>

            <!-- Volume 24h -->
            <Grid Margin="0,0,0,16">
              <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
              </Grid.ColumnDefinitions>
              <TextBlock Text="Volume (24h)" Style="{StaticResource BoardSubheaderText}"/>
              <TextBlock Grid.Column="1" Text="{Binding FormattedVolume}" 
                        FontWeight="SemiBold"/>
            </Grid>

            <!-- Total Supply -->
            <Grid Margin="0,0,0,16">
              <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
              </Grid.ColumnDefinitions>
              <TextBlock Text="Total Supply" Style="{StaticResource BoardSubheaderText}"/>
              <TextBlock Grid.Column="1" Text="{Binding CurrentCoin.TotalSupply, StringFormat=N0}" 
                        FontWeight="SemiBold"/>
            </Grid>

            <!-- Circulating Supply -->
            <Grid Margin="0,0,0,16">
              <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
              </Grid.ColumnDefinitions>
              <TextBlock Text="Circulating" Style="{StaticResource BoardSubheaderText}"/>
              <TextBlock Grid.Column="1" Text="{Binding CurrentCoin.CirculatingSupply, StringFormat=N0}" 
                        FontWeight="SemiBold"/>
            </Grid>

            <!-- Your Holdings -->
            <Border Background="{DynamicResource SecondRegionBrush}" 
                   Padding="16" CornerRadius="8" Margin="0,16,0,0">
              <StackPanel>
                <TextBlock Text="Your Holdings" Style="{StaticResource BoardSubheaderText}"/>
                <TextBlock Text="{Binding FormattedHoldings}" 
                          FontSize="18" FontWeight="Bold"
                          Foreground="{DynamicResource PrimaryBrush}"/>
                <TextBlock Text="{Binding FormattedHoldingsValue}" 
                          FontSize="14" Foreground="{DynamicResource SecondaryTextBrush}"/>
                <TextBlock Text="{Binding FormattedPnL}" FontSize="12" Margin="0,4,0,0">
                  <TextBlock.Style>
                    <Style TargetType="TextBlock">
                      <Style.Triggers>
                        <DataTrigger Binding="{Binding UserPortfolio.UnrealizedPnL, Converter={StaticResource IsPositiveConverter}}" Value="True">
                          <Setter Property="Foreground" Value="#10B981"/>
                        </DataTrigger>
                        <DataTrigger Binding="{Binding UserPortfolio.UnrealizedPnL, Converter={StaticResource IsPositiveConverter}}" Value="False">
                          <Setter Property="Foreground" Value="#EF4444"/>
                        </DataTrigger>
                      </Style.Triggers>
                    </Style>
                  </TextBlock.Style>
                </TextBlock>
              </StackPanel>
            </Border>
          </StackPanel>
        </Border>

        <!-- Trading Panel -->
        <Border Grid.Column="1" Style="{StaticResource TradingBoard}" Margin="5,0">
          <StackPanel>
            <TextBlock Text="Trade" Style="{StaticResource BoardHeaderText}"/>
            
            <!-- Buy/Sell Toggle -->
            <ToggleButton IsChecked="{Binding TradingMode, Converter={StaticResource String2BooleanConverter}, ConverterParameter=Sell}"
                         Margin="0,0,0,20">
              <ToggleButton.Style>
                <Style TargetType="ToggleButton" BasedOn="{StaticResource {x:Type ToggleButton}}">
                  <Setter Property="Content" Value="BUY"/>
                  <Setter Property="Background" Value="{StaticResource BuyGreenBrush}"/>
                  <Setter Property="Foreground" Value="White"/>
                  <Setter Property="FontWeight" Value="Bold"/>
                  <Setter Property="Padding" Value="20,12"/>
                  <Setter Property="BorderThickness" Value="0"/>
                  <Setter Property="FontSize" Value="14"/>
                  <Setter Property="Template">
                    <Setter.Value>
                      <ControlTemplate TargetType="ToggleButton">
                        <Border Background="{TemplateBinding Background}"
                               CornerRadius="8"
                               Padding="{TemplateBinding Padding}">
                          <ContentPresenter HorizontalAlignment="Center" 
                                          VerticalAlignment="Center"/>
                        </Border>
                      </ControlTemplate>
                    </Setter.Value>
                  </Setter>
                  <Style.Triggers>
                    <Trigger Property="IsChecked" Value="True">
                      <Setter Property="Content" Value="SELL"/>
                      <Setter Property="Background" Value="{StaticResource SellRedBrush}"/>
                    </Trigger>
                    <Trigger Property="IsMouseOver" Value="True">
                      <Setter Property="Opacity" Value="0.8"/>
                    </Trigger>
                  </Style.Triggers>
                </Style>
              </ToggleButton.Style>
            </ToggleButton>

            <!-- Balance Display -->
            <Grid Margin="0,0,0,16">
              <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
              </Grid.ColumnDefinitions>
              <TextBlock Text="Available:" Style="{StaticResource BoardSubheaderText}"/>
              <TextBlock Grid.Column="1" FontWeight="SemiBold">
                <TextBlock.Style>
                  <Style TargetType="TextBlock">
                    <Style.Triggers>
                      <DataTrigger Binding="{Binding TradingMode}" Value="Buy">
                        <Setter Property="Text" Value="{Binding FormattedBalance}"/>
                      </DataTrigger>
                      <DataTrigger Binding="{Binding TradingMode}" Value="Sell">
                        <Setter Property="Text" Value="{Binding FormattedHoldings}"/>
                      </DataTrigger>
                    </Style.Triggers>
                  </Style>
                </TextBlock.Style>
              </TextBlock>
            </Grid>

            <!-- Amount Input -->
            <StackPanel Margin="0,0,0,16">
              <TextBlock Text="Amount" Style="{StaticResource BoardSubheaderText}"/>
              <Grid>
                <Grid.ColumnDefinitions>
                  <ColumnDefinition Width="*"/>
                  <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                <hc:NumericUpDown Grid.Column="0"
                                 Value="{Binding TradeAmount, Mode=TwoWay}"
                                 Minimum="0"
                                 DecimalPlaces="8"
                                 IsEnabled="{Binding CanTrade}"/>
                <Button Grid.Column="1" Content="MAX" 
                       Margin="8,0,0,0" Padding="8,4"
                       FontSize="10">
                  <Button.Style>
                    <Style TargetType="Button" BasedOn="{StaticResource RugplayButton}">
                      <Style.Triggers>
                        <DataTrigger Binding="{Binding TradingMode}" Value="Buy">
                          <Setter Property="Command" Value="{Binding SetMaxBuyCommand}"/>
                        </DataTrigger>
                        <DataTrigger Binding="{Binding TradingMode}" Value="Sell">
                          <Setter Property="Command" Value="{Binding SetMaxSellCommand}"/>
                        </DataTrigger>
                      </Style.Triggers>
                    </Style>
                  </Button.Style>
                </Button>
              </Grid>
            </StackPanel>

            <!-- Trade Preview -->
            <Border Background="{DynamicResource SecondRegionBrush}" 
                   Padding="12" CornerRadius="6" Margin="0,0,0,16">
              <StackPanel>
                <Grid Margin="0,0,0,8">
                  <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                  </Grid.ColumnDefinitions>
                  <TextBlock Text="You get:" FontSize="12"/>
                  <TextBlock Grid.Column="1" FontSize="12" FontWeight="SemiBold">
                    <TextBlock.Style>
                      <Style TargetType="TextBlock">
                        <Style.Triggers>
                          <DataTrigger Binding="{Binding TradingMode}" Value="Buy">
                            <Setter Property="Text" Value="{Binding EstimatedTokensFormatted}"/>
                          </DataTrigger>
                          <DataTrigger Binding="{Binding TradingMode}" Value="Sell">
                            <Setter Property="Text" Value="{Binding EstimatedUsdFormatted}"/>
                          </DataTrigger>
                        </Style.Triggers>
                      </Style>
                    </TextBlock.Style>
                  </TextBlock>
                </Grid>
                
                <Grid>
                  <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                  </Grid.ColumnDefinitions>
                  <TextBlock Text="Price Impact:" FontSize="12"/>
                  <TextBlock Grid.Column="1" Text="{Binding PriceImpactFormatted}" 
                            FontSize="12" FontWeight="SemiBold"
                            Foreground="#F59E0B"/>
                </Grid>
              </StackPanel>
            </Border>

            <!-- Trade Button -->
            <Button Command="{Binding ExecuteTradeCommand}"
                   IsEnabled="{Binding CanTrade}"
                   Padding="0,12">
              <Button.Style>
                <Style TargetType="Button" BasedOn="{StaticResource RugplayButton}">
                  <Style.Triggers>
                    <DataTrigger Binding="{Binding TradingMode}" Value="Buy">
                      <Setter Property="Content" Value="BUY"/>
                      <Setter Property="Background" Value="{StaticResource BuyGreenBrush}"/>
                    </DataTrigger>
                    <DataTrigger Binding="{Binding TradingMode}" Value="Sell">
                      <Setter Property="Content" Value="SELL"/>
                      <Setter Property="Background" Value="{StaticResource SellRedBrush}"/>
                    </DataTrigger>
                  </Style.Triggers>
                </Style>
              </Button.Style>
            </Button>

            <!-- Trade Result -->
            <TextBlock Text="{Binding LastTradeResult}" 
                      TextWrapping="Wrap"
                      Margin="0,12,0,0"
                      FontSize="12"
                      Visibility="{Binding LastTradeResult, Converter={StaticResource String2VisibilityConverter}}"/>
          </StackPanel>
        </Border>

        <!-- Recent Trades -->
        <Border Grid.Column="2" Style="{StaticResource InfoBoard}" Margin="10,0,0,0">
          <StackPanel>
            <TextBlock Text="Recent Trades" Style="{StaticResource BoardHeaderText}"/>
            
            <ScrollViewer MaxHeight="400" VerticalScrollBarVisibility="Auto">
              <ItemsControl ItemsSource="{Binding RecentTrades}">
                <ItemsControl.ItemTemplate>
                  <DataTemplate>
                    <Border Background="{DynamicResource SecondRegionBrush}" 
                           Padding="12" CornerRadius="6" Margin="0,0,0,8">
                      <Grid>
                        <Grid.ColumnDefinitions>
                          <ColumnDefinition Width="Auto"/>
                          <ColumnDefinition Width="*"/>
                          <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        
                        <Border Grid.Column="0" 
                               Width="6" Height="6" CornerRadius="3"
                               VerticalAlignment="Center" Margin="0,0,8,0">
                          <Border.Style>
                            <Style TargetType="Border">
                              <Style.Triggers>
                                <DataTrigger Binding="{Binding Type}" Value="Buy">
                                  <Setter Property="Background" Value="#10B981"/>
                                </DataTrigger>
                                <DataTrigger Binding="{Binding Type}" Value="Sell">
                                  <Setter Property="Background" Value="#EF4444"/>
                                </DataTrigger>
                                <DataTrigger Binding="{Binding Type}" Value="RugPull">
                                  <Setter Property="Background" Value="#8B5CF6"/>
                                </DataTrigger>
                              </Style.Triggers>
                            </Style>
                          </Border.Style>
                        </Border>
                        
                        <StackPanel Grid.Column="1">
                          <TextBlock Text="{Binding GetDescription}" 
                                    FontSize="11" FontWeight="SemiBold"/>
                          <TextBlock Text="{Binding Timestamp, StringFormat=HH:mm:ss}" 
                                    FontSize="9" 
                                    Foreground="{DynamicResource SecondaryTextBrush}"/>
                        </StackPanel>
                        
                        <TextBlock Grid.Column="2" 
                                  Text="{Binding UsdAmount, StringFormat=C2}"
                                  FontSize="10" FontWeight="SemiBold"
                                  VerticalAlignment="Center"/>
                      </Grid>
                    </Border>
                  </DataTemplate>
                </ItemsControl.ItemTemplate>
              </ItemsControl>
            </ScrollViewer>
          </StackPanel>
        </Border>
      </Grid>
    </Grid>
  </ScrollViewer>
</UserControl>
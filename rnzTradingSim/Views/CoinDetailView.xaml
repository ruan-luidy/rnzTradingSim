<UserControl
  x:Class="rnzTradingSim.Views.CoinDetailView"
  xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
  xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
  xmlns:controls="clr-namespace:rnzTradingSim.Controls"
  xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
  xmlns:hc="https://handyorg.github.io/handycontrol"
  xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
  xmlns:vm="clr-namespace:rnzTradingSim.ViewModels"
  d:DataContext="{d:DesignInstance Type=vm:CoinDetailViewModel}"
  d:DesignHeight="800"
  d:DesignWidth="1200"
  Background="{StaticResource DarkBackgroundBrush}"
  mc:Ignorable="d">

  <ScrollViewer HorizontalScrollBarVisibility="Disabled" VerticalScrollBarVisibility="Auto">
    <Grid Margin="40">
      <Grid.RowDefinitions>
        <RowDefinition Height="Auto" />
        <RowDefinition Height="Auto" />
        <RowDefinition Height="*" />
      </Grid.RowDefinitions>

      <!--  Loading Indicator  -->
      <Grid
        Grid.Row="0"
        Grid.RowSpan="3"
        Background="{DynamicResource DarkOpacityBrush}"
        Visibility="{Binding IsLoading, Converter={StaticResource Boolean2VisibilityConverter}}">
        <hc:LoadingCircle
          HorizontalAlignment="Center"
          VerticalAlignment="Center"
          IsRunning="{Binding IsLoading}"
          Style="{StaticResource LoadingCircleLarge}" />
      </Grid>

      <!--  Header  -->
      <Border
        Grid.Row="0"
        Margin="0,0,0,20"
        Style="{StaticResource InfoBoard}">
        <Grid>
          <Grid.ColumnDefinitions>
            <ColumnDefinition Width="Auto" />
            <ColumnDefinition Width="*" />
            <ColumnDefinition Width="Auto" />
          </Grid.ColumnDefinitions>

          <!--  Coin Info  -->
          <StackPanel Grid.Column="0" Orientation="Horizontal">
            <controls:CoinIcon
              Margin="0,0,20,0"
              CoinSymbol="{Binding CurrentCoin.Symbol}"
              IconSize="60" />

            <StackPanel VerticalAlignment="Center">
              <TextBlock Style="{StaticResource BoardHeaderText}" Text="{Binding CurrentCoin.Name}" />
              <StackPanel Orientation="Horizontal">
                <TextBlock Style="{StaticResource BoardSubheaderText}" Text="{Binding CurrentCoin.Symbol}" />
                <Border
                  Margin="12,0,0,0"
                  Padding="6,2"
                  Background="#333"
                  CornerRadius="4">
                  <TextBlock
                    FontSize="10"
                    FontWeight="Bold"
                    Foreground="{DynamicResource SecondaryTextBrush}"
                    Text="Rank #1" />
                </Border>
              </StackPanel>
            </StackPanel>
          </StackPanel>

          <!--  Price Info  -->
          <StackPanel
            Grid.Column="1"
            Margin="40,0"
            VerticalAlignment="Center">
            <TextBlock Style="{StaticResource BoardValueText}" Text="{Binding FormattedPrice}" />
            <TextBlock
              FontSize="16"
              FontWeight="SemiBold"
              Text="{Binding FormattedPriceChange}">
              <TextBlock.Style>
                <Style TargetType="TextBlock">
                  <Style.Triggers>
                    <DataTrigger Binding="{Binding IsPriceUp}" Value="True">
                      <Setter Property="Foreground" Value="#10B981" />
                    </DataTrigger>
                    <DataTrigger Binding="{Binding IsPriceUp}" Value="False">
                      <Setter Property="Foreground" Value="#EF4444" />
                    </DataTrigger>
                  </Style.Triggers>
                </Style>
              </TextBlock.Style>
            </TextBlock>
          </StackPanel>

          <!--  Action Buttons  -->
          <StackPanel Grid.Column="2" Orientation="Horizontal">
            <Button
              Margin="0,0,12,0"
              Command="{Binding RefreshDataCommand}"
              Content="Refresh"
              Style="{StaticResource RugplayButton}" />

            <Button
              Command="{Binding RugPullCommand}"
              Content="RUG PULL"
              Style="{StaticResource SellButton}"
              Visibility="{Binding CanRugPull, Converter={StaticResource Boolean2VisibilityConverter}}" />
          </StackPanel>
        </Grid>
      </Border>

      <!--  Rug Warning  -->
      <Border
        Grid.Row="1"
        Margin="0,0,0,20"
        Style="{StaticResource RugWarningBorder}"
        Visibility="{Binding IsRugged, Converter={StaticResource Boolean2VisibilityConverter}}">
        <StackPanel Orientation="Horizontal">
          <TextBlock
            Margin="0,0,12,0"
            FontSize="20"
            Text="⚠️" />
          <StackPanel>
            <TextBlock
              FontSize="16"
              FontWeight="Bold"
              Foreground="#EF4444"
              Text="THIS COIN HAS BEEN RUGGED!" />
            <TextBlock
              FontSize="12"
              Foreground="#666"
              Text="All liquidity has been stolen. Trading is disabled." />
          </StackPanel>
        </StackPanel>
      </Border>

      <!--  Main Content  -->
      <Grid Grid.Row="2">
        <Grid.ColumnDefinitions>
          <ColumnDefinition Width="1*" />
          <ColumnDefinition Width="1*" />
          <ColumnDefinition Width="1*" />
        </Grid.ColumnDefinitions>

        <!--  Market Stats  -->
        <Border
          Grid.Column="0"
          Margin="0,0,10,0"
          Style="{StaticResource InfoBoard}">
          <StackPanel>
            <TextBlock Style="{StaticResource BoardHeaderText}" Text="Market Stats" />

            <!--  Market Cap  -->
            <Grid Margin="0,0,0,16">
              <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="Auto" />
              </Grid.ColumnDefinitions>
              <TextBlock Style="{StaticResource BoardSubheaderText}" Text="Market Cap" />
              <TextBlock
                Grid.Column="1"
                FontWeight="SemiBold"
                Text="{Binding FormattedMarketCap}" />
            </Grid>

            <!--  Volume 24h  -->
            <Grid Margin="0,0,0,16">
              <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="Auto" />
              </Grid.ColumnDefinitions>
              <TextBlock Style="{StaticResource BoardSubheaderText}" Text="Volume (24h)" />
              <TextBlock
                Grid.Column="1"
                FontWeight="SemiBold"
                Text="{Binding FormattedVolume}" />
            </Grid>

            <!--  Total Supply  -->
            <Grid Margin="0,0,0,16">
              <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="Auto" />
              </Grid.ColumnDefinitions>
              <TextBlock Style="{StaticResource BoardSubheaderText}" Text="Total Supply" />
              <TextBlock
                Grid.Column="1"
                FontWeight="SemiBold"
                Text="{Binding CurrentCoin.TotalSupply, StringFormat=N0}" />
            </Grid>

            <!--  Circulating Supply  -->
            <Grid Margin="0,0,0,16">
              <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="Auto" />
              </Grid.ColumnDefinitions>
              <TextBlock Style="{StaticResource BoardSubheaderText}" Text="Circulating" />
              <TextBlock
                Grid.Column="1"
                FontWeight="SemiBold"
                Text="{Binding CurrentCoin.CirculatingSupply, StringFormat=N0}" />
            </Grid>

            <!--  Your Holdings  -->
            <Border
              Margin="0,16,0,0"
              Padding="16"
              Background="{DynamicResource SecondRegionBrush}"
              CornerRadius="8">
              <StackPanel>
                <TextBlock Style="{StaticResource BoardSubheaderText}" Text="Your Holdings" />
                <TextBlock
                  FontSize="18"
                  FontWeight="Bold"
                  Foreground="{DynamicResource PrimaryBrush}"
                  Text="{Binding FormattedHoldings}" />
                <TextBlock
                  FontSize="14"
                  Foreground="{DynamicResource SecondaryTextBrush}"
                  Text="{Binding FormattedHoldingsValue}" />
                <TextBlock
                  Margin="0,4,0,0"
                  FontSize="12"
                  Foreground="#a1a1aa"
                  Text="{Binding FormattedPnL}" />
              </StackPanel>
            </Border>
          </StackPanel>
        </Border>

        <!--  Trading Panel  -->
        <Border
          Grid.Column="1"
          Margin="5,0"
          Style="{StaticResource TradingBoard}">
          <StackPanel>
            <TextBlock Style="{StaticResource BoardHeaderText}" Text="Trade" />

            <!--  Buy/Sell Toggle  -->
            <ToggleButton Margin="0,0,0,20" IsChecked="{Binding IsSellMode}">
              <ToggleButton.Style>
                <Style BasedOn="{StaticResource {x:Type ToggleButton}}" TargetType="ToggleButton">
                  <Setter Property="Content" Value="BUY" />
                  <Setter Property="Background" Value="{StaticResource BuyGreenBrush}" />
                  <Setter Property="Foreground" Value="White" />
                  <Setter Property="FontWeight" Value="Bold" />
                  <Setter Property="Padding" Value="20,12" />
                  <Setter Property="BorderThickness" Value="0" />
                  <Setter Property="FontSize" Value="14" />
                  <Setter Property="Template">
                    <Setter.Value>
                      <ControlTemplate TargetType="ToggleButton">
                        <Border
                          Padding="{TemplateBinding Padding}"
                          Background="{TemplateBinding Background}"
                          CornerRadius="8">
                          <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center" />
                        </Border>
                      </ControlTemplate>
                    </Setter.Value>
                  </Setter>
                  <Style.Triggers>
                    <Trigger Property="IsChecked" Value="True">
                      <Setter Property="Content" Value="SELL" />
                      <Setter Property="Background" Value="{StaticResource SellRedBrush}" />
                    </Trigger>
                    <Trigger Property="IsMouseOver" Value="True">
                      <Setter Property="Opacity" Value="0.8" />
                    </Trigger>
                  </Style.Triggers>
                </Style>
              </ToggleButton.Style>
            </ToggleButton>

            <!--  Balance Display  -->
            <Grid Margin="0,0,0,16">
              <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="Auto" />
              </Grid.ColumnDefinitions>
              <TextBlock Style="{StaticResource BoardSubheaderText}" Text="Available:" />
              <TextBlock Grid.Column="1" FontWeight="SemiBold">
                <TextBlock.Style>
                  <Style TargetType="TextBlock">
                    <Style.Triggers>
                      <DataTrigger Binding="{Binding TradingMode}" Value="Buy">
                        <Setter Property="Text" Value="{Binding FormattedBalance}" />
                      </DataTrigger>
                      <DataTrigger Binding="{Binding TradingMode}" Value="Sell">
                        <Setter Property="Text" Value="{Binding FormattedHoldings}" />
                      </DataTrigger>
                    </Style.Triggers>
                  </Style>
                </TextBlock.Style>
              </TextBlock>
            </Grid>

            <!--  Amount Input  -->
            <StackPanel Margin="0,0,0,16">
              <TextBlock Style="{StaticResource BoardSubheaderText}" Text="Amount" />
              <Grid>
                <Grid.ColumnDefinitions>
                  <ColumnDefinition Width="*" />
                  <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>
                <hc:NumericUpDown
                  Grid.Column="0"
                  DecimalPlaces="8"
                  IsEnabled="{Binding CanTrade}"
                  Minimum="0"
                  Value="{Binding TradeAmount, Mode=TwoWay}" />
                <Button
                  Grid.Column="1"
                  Margin="8,0,0,0"
                  Padding="8,4"
                  Content="MAX"
                  FontSize="10">
                  <Button.Style>
                    <Style BasedOn="{StaticResource RugplayButton}" TargetType="Button">
                      <Style.Triggers>
                        <DataTrigger Binding="{Binding TradingMode}" Value="Buy">
                          <Setter Property="Command" Value="{Binding SetMaxBuyCommand}" />
                        </DataTrigger>
                        <DataTrigger Binding="{Binding TradingMode}" Value="Sell">
                          <Setter Property="Command" Value="{Binding SetMaxSellCommand}" />
                        </DataTrigger>
                      </Style.Triggers>
                    </Style>
                  </Button.Style>
                </Button>
              </Grid>
            </StackPanel>

            <!--  Trade Preview  -->
            <Border
              Margin="0,0,0,16"
              Padding="12"
              Background="{DynamicResource SecondRegionBrush}"
              CornerRadius="6">
              <StackPanel>
                <Grid Margin="0,0,0,8">
                  <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                  </Grid.ColumnDefinitions>
                  <TextBlock FontSize="12" Text="You get:" />
                  <TextBlock
                    Grid.Column="1"
                    FontSize="12"
                    FontWeight="SemiBold">
                    <TextBlock.Style>
                      <Style TargetType="TextBlock">
                        <Style.Triggers>
                          <DataTrigger Binding="{Binding TradingMode}" Value="Buy">
                            <Setter Property="Text" Value="{Binding EstimatedTokensFormatted}" />
                          </DataTrigger>
                          <DataTrigger Binding="{Binding TradingMode}" Value="Sell">
                            <Setter Property="Text" Value="{Binding EstimatedUsdFormatted}" />
                          </DataTrigger>
                        </Style.Triggers>
                      </Style>
                    </TextBlock.Style>
                  </TextBlock>
                </Grid>

                <Grid>
                  <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                  </Grid.ColumnDefinitions>
                  <TextBlock FontSize="12" Text="Price Impact:" />
                  <TextBlock
                    Grid.Column="1"
                    FontSize="12"
                    FontWeight="SemiBold"
                    Foreground="#F59E0B"
                    Text="{Binding PriceImpactFormatted}" />
                </Grid>
              </StackPanel>
            </Border>

            <!--  Trade Button  -->
            <Button
              Padding="0,12"
              Command="{Binding ExecuteTradeCommand}"
              IsEnabled="{Binding CanTrade}">
              <Button.Style>
                <Style BasedOn="{StaticResource RugplayButton}" TargetType="Button">
                  <Style.Triggers>
                    <DataTrigger Binding="{Binding TradingMode}" Value="Buy">
                      <Setter Property="Content" Value="BUY" />
                      <Setter Property="Background" Value="{StaticResource BuyGreenBrush}" />
                    </DataTrigger>
                    <DataTrigger Binding="{Binding TradingMode}" Value="Sell">
                      <Setter Property="Content" Value="SELL" />
                      <Setter Property="Background" Value="{StaticResource SellRedBrush}" />
                    </DataTrigger>
                  </Style.Triggers>
                </Style>
              </Button.Style>
            </Button>

            <!--  Trade Result  -->
            <TextBlock
              Margin="0,12,0,0"
              FontSize="12"
              Text="{Binding LastTradeResult}"
              TextWrapping="Wrap"
              Visibility="{Binding LastTradeResult, Converter={StaticResource String2VisibilityConverter}}" />
          </StackPanel>
        </Border>

        <!--  Recent Trades  -->
        <Border
          Grid.Column="2"
          Margin="10,0,0,0"
          Style="{StaticResource InfoBoard}">
          <StackPanel>
            <TextBlock Style="{StaticResource BoardHeaderText}" Text="Recent Trades" />

            <ScrollViewer MaxHeight="400" VerticalScrollBarVisibility="Auto">
              <ItemsControl ItemsSource="{Binding RecentTrades}">
                <ItemsControl.ItemTemplate>
                  <DataTemplate>
                    <Border
                      Margin="0,0,0,8"
                      Padding="12"
                      Background="{DynamicResource SecondRegionBrush}"
                      CornerRadius="6">
                      <Grid>
                        <Grid.ColumnDefinitions>
                          <ColumnDefinition Width="Auto" />
                          <ColumnDefinition Width="*" />
                          <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>

                        <Border
                          Grid.Column="0"
                          Width="6"
                          Height="6"
                          Margin="0,0,8,0"
                          VerticalAlignment="Center"
                          CornerRadius="3">
                          <Border.Style>
                            <Style TargetType="Border">
                              <Style.Triggers>
                                <DataTrigger Binding="{Binding Type}" Value="Buy">
                                  <Setter Property="Background" Value="#10B981" />
                                </DataTrigger>
                                <DataTrigger Binding="{Binding Type}" Value="Sell">
                                  <Setter Property="Background" Value="#EF4444" />
                                </DataTrigger>
                                <DataTrigger Binding="{Binding Type}" Value="RugPull">
                                  <Setter Property="Background" Value="#8B5CF6" />
                                </DataTrigger>
                              </Style.Triggers>
                            </Style>
                          </Border.Style>
                        </Border>

                        <StackPanel Grid.Column="1">
                          <TextBlock
                            FontSize="11"
                            FontWeight="SemiBold"
                            Text="{Binding GetDescription}" />
                          <TextBlock
                            FontSize="9"
                            Foreground="{DynamicResource SecondaryTextBrush}"
                            Text="{Binding Timestamp, StringFormat=HH:mm:ss}" />
                        </StackPanel>

                        <TextBlock
                          Grid.Column="2"
                          VerticalAlignment="Center"
                          FontSize="10"
                          FontWeight="SemiBold"
                          Text="{Binding UsdAmount, StringFormat=C2}" />
                      </Grid>
                    </Border>
                  </DataTemplate>
                </ItemsControl.ItemTemplate>
              </ItemsControl>
            </ScrollViewer>
          </StackPanel>
        </Border>
      </Grid>
    </Grid>
  </ScrollViewer>
</UserControl>
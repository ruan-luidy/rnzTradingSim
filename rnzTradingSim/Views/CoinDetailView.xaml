<UserControl
  x:Class="rnzTradingSim.Views.CoinDetailView"
  xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
  xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
  xmlns:controls="clr-namespace:rnzTradingSim.Controls"
  xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
  xmlns:hc="https://handyorg.github.io/handycontrol"
  xmlns:lvc="clr-namespace:LiveChartsCore.SkiaSharpView.WPF;assembly=LiveChartsCore.SkiaSharpView.WPF"
  xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
  xmlns:vm="clr-namespace:rnzTradingSim.ViewModels"
  d:DataContext="{d:DesignInstance Type=vm:CoinDetailViewModel}"
  d:DesignHeight="900"
  d:DesignWidth="1400"
  Background="{StaticResource DarkBackgroundBrush}"
  mc:Ignorable="d">

  <ScrollViewer HorizontalScrollBarVisibility="Disabled" VerticalScrollBarVisibility="Auto">
    <Grid Margin="24">
      <Grid.RowDefinitions>
        <RowDefinition Height="Auto" />
        <RowDefinition Height="Auto" />
        <RowDefinition Height="*" />
      </Grid.RowDefinitions>

      <!--  Loading Indicator  -->
      <Grid 
        Grid.Row="0" 
        Grid.RowSpan="3"
        Background="{DynamicResource DarkOpacityBrush}"
        Visibility="{Binding IsLoading, Converter={StaticResource Boolean2VisibilityConverter}}">
        <hc:LoadingCircle
          HorizontalAlignment="Center"
          VerticalAlignment="Center"
          IsRunning="{Binding IsLoading}"
          Style="{StaticResource LoadingCircleLarge}" />
      </Grid>

      <!--  Header with Coin Info  -->
      <Border Grid.Row="0" Margin="0,0,0,32">
        <Grid>
          <Grid.ColumnDefinitions>
            <ColumnDefinition Width="*" />
            <ColumnDefinition Width="Auto" />
          </Grid.ColumnDefinitions>
          
          <!--  Coin Info and Price  -->
          <StackPanel Grid.Column="0">
            <StackPanel Orientation="Horizontal" Margin="0,0,0,16">
              <controls:CoinIcon
                Margin="0,0,16,0"
                CoinSymbol="{Binding CurrentCoin.Symbol}"
                IconSize="48" />

              <StackPanel VerticalAlignment="Center">
                <StackPanel Orientation="Horizontal">
                  <TextBlock
                    FontSize="24"
                    FontWeight="Bold"
                    Foreground="White"
                    Text="{Binding CurrentCoin.Name}" />
                  <TextBlock
                    Margin="12,0,0,0"
                    VerticalAlignment="Center"
                    FontSize="16"
                    Foreground="{DynamicResource SecondaryTextBrush}"
                    Text="{Binding CurrentCoin.Symbol, StringFormat=*{0}}" />
                </StackPanel>
                
                <!--  Status Badges  -->
                <StackPanel Orientation="Horizontal" Margin="0,8,0,0">
                  <Border
                    Padding="8,4"
                    Background="#16a34a"
                    CornerRadius="4">
                    <TextBlock
                      FontSize="12"
                      FontWeight="Medium"
                      Foreground="White"
                      Text="LIVE" />
                  </Border>
                  
                  <Border
                    Margin="8,0,0,0"
                    Padding="8,4"
                    Background="{DynamicResource SecondaryRegionBrush}"
                    CornerRadius="4"
                    Visibility="{Binding IsRugged, Converter={StaticResource Boolean2VisibilityConverter}}">
                    <TextBlock
                      FontSize="12"
                      FontWeight="Medium"
                      Foreground="#ef4444"
                      Text="RUGGED" />
                  </Border>
                </StackPanel>
              </StackPanel>
            </StackPanel>

            <!--  Price Info  -->
            <StackPanel>
              <TextBlock
                FontSize="36"
                FontWeight="Bold"
                Foreground="White"
                Text="{Binding FormattedPrice}" />
              <StackPanel Orientation="Horizontal" Margin="0,4,0,0">
                <TextBlock
                  FontSize="16"
                  FontWeight="Medium"
                  Text="{Binding FormattedPriceChange}">
                  <TextBlock.Style>
                    <Style TargetType="TextBlock">
                      <Style.Triggers>
                        <DataTrigger Binding="{Binding IsPriceUp}" Value="True">
                          <Setter Property="Foreground" Value="#16a34a" />
                        </DataTrigger>
                        <DataTrigger Binding="{Binding IsPriceUp}" Value="False">
                          <Setter Property="Foreground" Value="#ef4444" />
                        </DataTrigger>
                      </Style.Triggers>
                    </Style>
                  </TextBlock.Style>
                </TextBlock>
                <TextBlock
                  Margin="8,0,0,0"
                  FontSize="14"
                  Foreground="{DynamicResource SecondaryTextBrush}"
                  Text="24h" />
              </StackPanel>
            </StackPanel>
          </StackPanel>

          <!--  Action Buttons  -->
          <StackPanel Grid.Column="1" Orientation="Horizontal" VerticalAlignment="Top">
            <Button
              Height="40"
              Margin="0,0,12,0"
              Padding="16,0"
              hc:BorderElement.CornerRadius="8"
              Background="{DynamicResource RegionBrush}"
              BorderBrush="{DynamicResource BorderBrush}"
              BorderThickness="1"
              Command="{Binding RefreshDataCommand}"
              Foreground="White">
              <StackPanel Orientation="Horizontal">
                <TextBlock Text="ðŸ”„" Margin="0,0,8,0" />
                <TextBlock Text="Refresh" />
              </StackPanel>
            </Button>

            <Button
              Height="40"
              Padding="16,0"
              hc:BorderElement.CornerRadius="8"
              Background="#ef4444"
              BorderBrush="#ef4444"
              Command="{Binding RugPullCommand}"
              Foreground="White"
              Visibility="{Binding CanRugPull, Converter={StaticResource Boolean2VisibilityConverter}}">
              <StackPanel Orientation="Horizontal">
                <TextBlock Text="ðŸ’€" Margin="0,0,8,0" />
                <TextBlock Text="RUG PULL" FontWeight="Bold" />
              </StackPanel>
            </Button>
          </StackPanel>
        </Grid>
      </Border>

      <!--  Stats Cards  -->
      <Grid Grid.Row="1" Margin="0,0,0,32">
        <Grid.ColumnDefinitions>
          <ColumnDefinition Width="*" />
          <ColumnDefinition Width="*" />
          <ColumnDefinition Width="*" />
          <ColumnDefinition Width="*" />
        </Grid.ColumnDefinitions>

        <!--  Market Cap  -->
        <Border
          Grid.Column="0"
          Margin="0,0,8,0"
          Padding="24,16"
          Background="{DynamicResource CardBackgroundBrush}"
          BorderBrush="{DynamicResource BorderBrush}"
          BorderThickness="1"
          CornerRadius="8">
          <StackPanel>
            <TextBlock
              FontSize="14"
              Foreground="{DynamicResource SecondaryTextBrush}"
              Text="Market Cap" />
            <TextBlock
              Margin="0,4,0,0"
              FontSize="20"
              FontWeight="Bold"
              Foreground="White"
              Text="{Binding FormattedMarketCap}" />
          </StackPanel>
        </Border>

        <!--  Volume 24h  -->
        <Border
          Grid.Column="1"
          Margin="8,0"
          Padding="24,16"
          Background="{DynamicResource CardBackgroundBrush}"
          BorderBrush="{DynamicResource BorderBrush}"
          BorderThickness="1"
          CornerRadius="8">
          <StackPanel>
            <TextBlock
              FontSize="14"
              Foreground="{DynamicResource SecondaryTextBrush}"
              Text="Volume 24h" />
            <TextBlock
              Margin="0,4,0,0"
              FontSize="20"
              FontWeight="Bold"
              Foreground="White"
              Text="{Binding FormattedVolume}" />
          </StackPanel>
        </Border>

        <!--  Circulating Supply  -->
        <Border
          Grid.Column="2"
          Margin="8,0"
          Padding="24,16"
          Background="{DynamicResource CardBackgroundBrush}"
          BorderBrush="{DynamicResource BorderBrush}"
          BorderThickness="1"
          CornerRadius="8">
          <StackPanel>
            <TextBlock
              FontSize="14"
              Foreground="{DynamicResource SecondaryTextBrush}"
              Text="Circulating Supply" />
            <TextBlock
              Margin="0,4,0,0"
              FontSize="20"
              FontWeight="Bold"
              Foreground="White"
              Text="{Binding CurrentCoin.CirculatingSupply, StringFormat=N0}" />
          </StackPanel>
        </Border>

        <!--  24h Change  -->
        <Border
          Grid.Column="3"
          Margin="8,0,0,0"
          Padding="24,16"
          Background="{DynamicResource CardBackgroundBrush}"
          BorderBrush="{DynamicResource BorderBrush}"
          BorderThickness="1"
          CornerRadius="8">
          <StackPanel>
            <TextBlock
              FontSize="14"
              Foreground="{DynamicResource SecondaryTextBrush}"
              Text="24h Change" />
            <TextBlock
              Margin="0,4,0,0"
              FontSize="20"
              FontWeight="Bold"
              Text="{Binding FormattedPriceChange}">
              <TextBlock.Style>
                <Style TargetType="TextBlock">
                  <Style.Triggers>
                    <DataTrigger Binding="{Binding IsPriceUp}" Value="True">
                      <Setter Property="Foreground" Value="#16a34a" />
                    </DataTrigger>
                    <DataTrigger Binding="{Binding IsPriceUp}" Value="False">
                      <Setter Property="Foreground" Value="#ef4444" />
                    </DataTrigger>
                  </Style.Triggers>
                </Style>
              </TextBlock.Style>
            </TextBlock>
          </StackPanel>
        </Border>
      </Grid>

      <!--  Main Content Grid  -->
      <Grid Grid.Row="2">
        <Grid.ColumnDefinitions>
          <ColumnDefinition Width="2*" />
          <ColumnDefinition Width="1*" />
        </Grid.ColumnDefinitions>

        <!--  Chart Section  -->
        <Border
          Grid.Column="0"
          Margin="0,0,16,0"
          Background="{DynamicResource CardBackgroundBrush}"
          BorderBrush="{DynamicResource BorderBrush}"
          BorderThickness="1"
          CornerRadius="8">
          <Grid>
            <Grid.RowDefinitions>
              <RowDefinition Height="Auto" />
              <RowDefinition Height="*" />
            </Grid.RowDefinitions>

            <!--  Chart Header  -->
            <Border Grid.Row="0" Padding="24,20">
              <Grid>
                <Grid.ColumnDefinitions>
                  <ColumnDefinition Width="*" />
                  <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>
                
                <TextBlock
                  Grid.Column="0"
                  FontSize="18"
                  FontWeight="SemiBold"
                  Foreground="White"
                  Text="Price Chart" />

                <!--  Timeframe Selector  -->
                <StackPanel Grid.Column="1" Orientation="Horizontal">
                  <RadioButton Content="1m" Style="{StaticResource TimeframeRadioButton}" IsChecked="True" />
                  <RadioButton Content="5m" Style="{StaticResource TimeframeRadioButton}" Margin="8,0,0,0" />
                  <RadioButton Content="15m" Style="{StaticResource TimeframeRadioButton}" Margin="8,0,0,0" />
                  <RadioButton Content="1h" Style="{StaticResource TimeframeRadioButton}" Margin="8,0,0,0" />
                  <RadioButton Content="4h" Style="{StaticResource TimeframeRadioButton}" Margin="8,0,0,0" />
                  <RadioButton Content="1d" Style="{StaticResource TimeframeRadioButton}" Margin="8,0,0,0" />
                </StackPanel>
              </Grid>
            </Border>

            <!--  Chart Container  -->
            <Border Grid.Row="1" Margin="24,0,24,24">
              <Grid>
                <lvc:CartesianChart 
                  Series="{Binding ChartSeries}"
                  XAxes="{Binding XAxes}"
                  YAxes="{Binding YAxes}"
                  ZoomMode="X"
                  Background="Transparent"
                  Height="400" />
                
                <!--  Chart Loading  -->
                <Grid Visibility="{Binding IsChartLoading, Converter={StaticResource Boolean2VisibilityConverter}}">
                  <Border Background="{DynamicResource DarkOpacityBrush}" />
                  <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center">
                    <hc:LoadingCircle IsRunning="{Binding IsChartLoading}" />
                    <TextBlock
                      Margin="0,12,0,0"
                      FontSize="14"
                      Foreground="{DynamicResource SecondaryTextBrush}"
                      Text="Loading chart data..." />
                  </StackPanel>
                </Grid>
              </Grid>
            </Border>
          </Grid>
        </Border>

        <!--  Right Panel  -->
        <Grid Grid.Column="1">
          <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
          </Grid.RowDefinitions>

          <!--  Trading Panel  -->
          <Border
            Grid.Row="0"
            Margin="0,0,0,16"
            Background="{DynamicResource CardBackgroundBrush}"
            BorderBrush="{DynamicResource BorderBrush}"
            BorderThickness="1"
            CornerRadius="8">
            <StackPanel Margin="24">
              <TextBlock
                FontSize="18"
                FontWeight="SemiBold"
                Foreground="White"
                Text="Trade" />

              <!--  Buy/Sell Toggle  -->
              <Grid Margin="0,20,0,20">
                <Grid.ColumnDefinitions>
                  <ColumnDefinition Width="*" />
                  <ColumnDefinition Width="*" />
                </Grid.ColumnDefinitions>
                
                <RadioButton
                  Grid.Column="0"
                  Content="Buy"
                  GroupName="TradeMode"
                  IsChecked="{Binding IsBuyMode}"
                  Style="{StaticResource TradeToggleButton}" />
                <RadioButton
                  Grid.Column="1"
                  Content="Sell"
                  GroupName="TradeMode"
                  IsChecked="{Binding IsSellMode}"
                  Style="{StaticResource TradeToggleButton}" />
              </Grid>

              <!--  Balance Display  -->
              <Grid Margin="0,0,0,16">
                <Grid.ColumnDefinitions>
                  <ColumnDefinition Width="*" />
                  <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>
                <TextBlock
                  FontSize="14"
                  Foreground="{DynamicResource SecondaryTextBrush}"
                  Text="Available:" />
                <TextBlock
                  Grid.Column="1"
                  FontSize="14"
                  FontWeight="Medium"
                  Foreground="White"
                  Text="{Binding FormattedAvailableBalance}" />
              </Grid>

              <!--  Amount Input  -->
              <StackPanel Margin="0,0,0,16">
                <TextBlock
                  Margin="0,0,0,8"
                  FontSize="14"
                  Foreground="{DynamicResource SecondaryTextBrush}"
                  Text="Amount" />
                <Grid>
                  <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                  </Grid.ColumnDefinitions>
                  <TextBox
                    Grid.Column="0"
                    Padding="12,8"
                    Background="{DynamicResource RegionBrush}"
                    BorderBrush="{DynamicResource BorderBrush}"
                    BorderThickness="1"
                    Foreground="White"
                    Text="{Binding TradeAmount, Mode=TwoWay}" />
                  <Button
                    Grid.Column="1"
                    Width="60"
                    Margin="8,0,0,0"
                    Padding="8"
                    hc:BorderElement.CornerRadius="4"
                    Background="{DynamicResource SecondaryRegionBrush}"
                    BorderBrush="{DynamicResource BorderBrush}"
                    BorderThickness="1"
                    Command="{Binding SetMaxAmountCommand}"
                    Content="MAX"
                    FontSize="12"
                    FontWeight="Bold"
                    Foreground="White" />
                </Grid>
              </StackPanel>

              <!--  Estimation Preview  -->
              <Border
                Margin="0,0,0,20"
                Padding="16"
                Background="{DynamicResource SecondaryRegionBrush}"
                CornerRadius="6">
                <StackPanel>
                  <Grid Margin="0,0,0,8">
                    <Grid.ColumnDefinitions>
                      <ColumnDefinition Width="*" />
                      <ColumnDefinition Width="Auto" />
                    </Grid.ColumnDefinitions>
                    <TextBlock
                      FontSize="14"
                      Foreground="{DynamicResource SecondaryTextBrush}"
                      Text="You get:" />
                    <TextBlock
                      Grid.Column="1"
                      FontSize="14"
                      FontWeight="Medium"
                      Foreground="White"
                      Text="{Binding EstimatedReceiveFormatted}" />
                  </Grid>
                  
                  <Grid>
                    <Grid.ColumnDefinitions>
                      <ColumnDefinition Width="*" />
                      <ColumnDefinition Width="Auto" />
                    </Grid.ColumnDefinitions>
                    <TextBlock
                      FontSize="14"
                      Foreground="{DynamicResource SecondaryTextBrush}"
                      Text="Price Impact:" />
                    <TextBlock
                      Grid.Column="1"
                      FontSize="14"
                      FontWeight="Medium"
                      Foreground="#f59e0b"
                      Text="{Binding PriceImpactFormatted}" />
                  </Grid>
                </StackPanel>
              </Border>

              <!--  Trade Button  -->
              <Button
                Padding="0,16"
                Command="{Binding ExecuteTradeCommand}"
                IsEnabled="{Binding CanTrade}">
                <Button.Style>
                  <Style BasedOn="{StaticResource RugplayButton}" TargetType="Button">
                    <Style.Triggers>
                      <DataTrigger Binding="{Binding IsBuyMode}" Value="True">
                        <Setter Property="Content" Value="BUY" />
                        <Setter Property="Background" Value="#16a34a" />
                        <Setter Property="BorderBrush" Value="#16a34a" />
                      </DataTrigger>
                      <DataTrigger Binding="{Binding IsSellMode}" Value="True">
                        <Setter Property="Content" Value="SELL" />
                        <Setter Property="Background" Value="#ef4444" />
                        <Setter Property="BorderBrush" Value="#ef4444" />
                      </DataTrigger>
                    </Style.Triggers>
                  </Style>
                </Button.Style>
              </Button>

              <!--  Your Holdings  -->
              <Border
                Margin="0,20,0,0"
                Padding="16"
                Background="{DynamicResource RegionBrush}"
                CornerRadius="6">
                <StackPanel>
                  <TextBlock
                    FontSize="14"
                    Foreground="{DynamicResource SecondaryTextBrush}"
                    Text="Your Holdings" />
                  <TextBlock
                    Margin="0,4,0,0"
                    FontSize="16"
                    FontWeight="Bold"
                    Foreground="White"
                    Text="{Binding FormattedHoldings}" />
                  <TextBlock
                    FontSize="14"
                    Foreground="{DynamicResource SecondaryTextBrush}"
                    Text="{Binding FormattedHoldingsValue}" />
                </StackPanel>
              </Border>
            </StackPanel>
          </Border>

          <!--  Recent Trades  -->
          <Border
            Grid.Row="1"
            Background="{DynamicResource CardBackgroundBrush}"
            BorderBrush="{DynamicResource BorderBrush}"
            BorderThickness="1"
            CornerRadius="8">
            <Grid>
              <Grid.RowDefinitions>
                <RowDefinition Height="Auto" />
                <RowDefinition Height="*" />
              </Grid.RowDefinitions>

              <!--  Header  -->
              <Border Grid.Row="0" Padding="24,20">
                <TextBlock
                  FontSize="18"
                  FontWeight="SemiBold"
                  Foreground="White"
                  Text="Recent Trades" />
              </Border>

              <!--  Trades List  -->
              <ScrollViewer Grid.Row="1" Padding="24,0,24,24" VerticalScrollBarVisibility="Auto">
                <ItemsControl ItemsSource="{Binding RecentTrades}">
                  <ItemsControl.ItemTemplate>
                    <DataTemplate>
                      <Border
                        Margin="0,0,0,8"
                        Padding="16,12"
                        Background="{DynamicResource SecondaryRegionBrush}"
                        CornerRadius="6">
                        <Grid>
                          <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto" />
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="Auto" />
                          </Grid.ColumnDefinitions>

                          <!--  Trade Type Indicator  -->
                          <Border
                            Grid.Column="0"
                            Width="8"
                            Height="8"
                            Margin="0,0,12,0"
                            VerticalAlignment="Center"
                            CornerRadius="4">
                            <Border.Style>
                              <Style TargetType="Border">
                                <Style.Triggers>
                                  <DataTrigger Binding="{Binding Type}" Value="Buy">
                                    <Setter Property="Background" Value="#16a34a" />
                                  </DataTrigger>
                                  <DataTrigger Binding="{Binding Type}" Value="Sell">
                                    <Setter Property="Background" Value="#ef4444" />
                                  </DataTrigger>
                                </Style.Triggers>
                              </Style>
                            </Border.Style>
                          </Border>

                          <!--  Trade Details  -->
                          <StackPanel Grid.Column="1">
                            <TextBlock
                              FontSize="14"
                              FontWeight="Medium"
                              Foreground="White"
                              Text="{Binding GetDescription}" />
                            <TextBlock
                              FontSize="12"
                              Foreground="{DynamicResource SecondaryTextBrush}"
                              Text="{Binding Timestamp, StringFormat=HH:mm:ss}" />
                          </StackPanel>

                          <!--  Amount  -->
                          <TextBlock
                            Grid.Column="2"
                            VerticalAlignment="Center"
                            FontSize="14"
                            FontWeight="Medium"
                            Foreground="White"
                            Text="{Binding UsdAmount, StringFormat=C2}" />
                        </Grid>
                      </Border>
                    </DataTemplate>
                  </ItemsControl.ItemTemplate>
                </ItemsControl>
              </ScrollViewer>
            </Grid>
          </Border>
        </Grid>
      </Grid>
    </Grid>
  </ScrollViewer>
</UserControl>
<UserControl
  x:Class="rnzTradingSim.Views.MarketView"
  xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
  xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
  xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
  xmlns:hc="https://handyorg.github.io/handycontrol"
  xmlns:local="clr-namespace:rnzTradingSim.Views"
  xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
  xmlns:vm="clr-namespace:rnzTradingSim.ViewModels"
  d:DataContext="{d:DesignInstance Type=vm:MarketViewModel}"
  d:DesignHeight="800"
  d:DesignWidth="1150"
  Background="{StaticResource DarkBackgroundBrush}"
  mc:Ignorable="d">

  <ScrollViewer HorizontalScrollBarVisibility="Disabled" VerticalScrollBarVisibility="Auto">
    <Grid Margin="24">
      <Grid.RowDefinitions>
        <RowDefinition Height="Auto" />
        <RowDefinition Height="Auto" />
        <RowDefinition Height="Auto" />
        <RowDefinition Height="*" />
        <RowDefinition Height="Auto" />
      </Grid.RowDefinitions>

      <!--  Header  -->
      <Border Grid.Row="0" Padding="0,0,0,32">
        <Grid>
          <Grid.ColumnDefinitions>
            <ColumnDefinition Width="*" />
            <ColumnDefinition Width="Auto" />
          </Grid.ColumnDefinitions>
          
          <StackPanel Grid.Column="0">
            <TextBlock
              FontSize="30"
              FontWeight="Bold"
              Foreground="White"
              Text="Market" />
            <TextBlock
              Margin="0,8,0,0"
              FontSize="16"
              Foreground="{DynamicResource SecondaryTextBrush}"
              Text="Discover coins, track performance, and find your next investment" />
          </StackPanel>

          <StackPanel Grid.Column="1" Orientation="Horizontal">
            <TextBlock
              VerticalAlignment="Center"
              Margin="0,0,16,0"
              FontSize="14"
              Foreground="{DynamicResource SecondaryTextBrush}"
              Text="{Binding ResultsText}" />
            
            <Button
              Height="40"
              Padding="16,0"
              hc:BorderElement.CornerRadius="8"
              Background="{StaticResource RugplayPrimaryBrush}"
              BorderBrush="{StaticResource RugplayPrimaryBrush}"
              Command="{Binding RefreshCommand}"
              Foreground="White">
              <StackPanel Orientation="Horizontal">
                <TextBlock Text="🔄" Margin="0,0,8,0" />
                <TextBlock Text="Refresh" />
              </StackPanel>
            </Button>
          </StackPanel>
        </Grid>
      </Border>

      <!--  Search and Filters  -->
      <Border Grid.Row="1" Padding="0,0,0,24">
        <Grid>
          <Grid.ColumnDefinitions>
            <ColumnDefinition Width="*" />
            <ColumnDefinition Width="Auto" />
          </Grid.ColumnDefinitions>

          <hc:SearchBar
            Grid.Column="0"
            Width="400"
            HorizontalAlignment="Left"
            hc:BorderElement.CornerRadius="8"
            hc:InfoElement.Placeholder="Search coins by name or symbol..."
            Text="{Binding SearchText, UpdateSourceTrigger=PropertyChanged}" />

          <StackPanel Grid.Column="1" Orientation="Horizontal">
            <Button
              Height="32"
              Margin="0,0,10,0"
              Padding="15,0"
              hc:BorderElement.CornerRadius="8"
              Background="{DynamicResource RegionBrush}"
              BorderBrush="{DynamicResource BorderBrush}"
              BorderThickness="1"
              Command="{Binding ShowFiltersCommand}"
              Content="Filters" />
            
            <ComboBox
              Width="120"
              Height="32"
              hc:BorderElement.CornerRadius="8"
              SelectedIndex="{Binding SortBy}"
              ToolTip="Sort by">
              <ComboBoxItem Content="Market Cap" />
              <ComboBoxItem Content="Price" />
              <ComboBoxItem Content="24h Change" />
              <ComboBoxItem Content="Volume" />
              <ComboBoxItem Content="Name" />
            </ComboBox>
          </StackPanel>
        </Grid>
      </Border>

      <!--  Loading Indicator  -->
      <Grid 
        Grid.Row="2" 
        Visibility="{Binding IsLoading, Converter={StaticResource Boolean2VisibilityConverter}}"
        Margin="0,0,0,24">
        <hc:LoadingCircle
          HorizontalAlignment="Center"
          VerticalAlignment="Center"
          IsRunning="{Binding IsLoading}"
          Style="{StaticResource LoadingCircleLarge}" />
      </Grid>

      <!--  All Coins Grid with Pagination  -->
      <Grid 
        Grid.Row="3" 
        Visibility="{Binding IsLoading, Converter={StaticResource Boolean2VisibilityReConverter}}">
        
        <ItemsControl ItemsSource="{Binding FilteredCoins}">
          <ItemsControl.ItemsPanel>
            <ItemsPanelTemplate>
              <UniformGrid Columns="4" />
            </ItemsPanelTemplate>
          </ItemsControl.ItemsPanel>
          <ItemsControl.ItemTemplate>
            <DataTemplate>
              <!--  Compact Coin Card for Market Grid  -->
              <Border
                Margin="6"
                Padding="20"
                Background="{DynamicResource CardBackgroundBrush}"
                BorderBrush="{DynamicResource BorderBrush}"
                BorderThickness="1"
                CornerRadius="8"
                Cursor="Hand"
                MouseLeftButtonUp="CoinCard_Click"
                Tag="{Binding}">
                <Border.Style>
                  <Style TargetType="Border">
                    <Style.Triggers>
                      <Trigger Property="IsMouseOver" Value="True">
                        <Setter Property="Background" Value="{DynamicResource SecondaryRegionBrush}" />
                        <Setter Property="Effect">
                          <Setter.Value>
                            <DropShadowEffect Color="#000000" BlurRadius="6" ShadowDepth="1" Opacity="0.2"/>
                          </Setter.Value>
                        </Setter>
                      </Trigger>
                    </Style.Triggers>
                  </Style>
                </Border.Style>

                <Grid>
                  <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="*" />
                  </Grid.RowDefinitions>

                  <!--  Header with Icon and Change  -->
                  <Grid Grid.Row="0" Margin="0,0,0,12">
                    <Grid.ColumnDefinitions>
                      <ColumnDefinition Width="Auto" />
                      <ColumnDefinition Width="*" />
                      <ColumnDefinition Width="Auto" />
                    </Grid.ColumnDefinitions>

                    <!--  Coin Icon  -->
                    <Border
                      Grid.Column="0"
                      Width="20"
                      Height="20"
                      Margin="0,0,8,0"
                      Background="{StaticResource RugplayPrimaryBrush}"
                      CornerRadius="10">
                      <TextBlock
                        HorizontalAlignment="Center"
                        VerticalAlignment="Center"
                        FontSize="8"
                        FontWeight="Bold"
                        Foreground="White"
                        Text="{Binding Symbol}" />
                    </Border>

                    <!--  Name & Symbol  -->
                    <StackPanel Grid.Column="1" VerticalAlignment="Center">
                      <TextBlock
                        FontSize="14"
                        FontWeight="SemiBold"
                        Foreground="White"
                        Text="{Binding Name}"
                        TextTrimming="CharacterEllipsis" />
                      <TextBlock
                        FontSize="11"
                        Foreground="{DynamicResource SecondaryTextBrush}"
                        Text="{Binding Symbol}" />
                    </StackPanel>

                    <!--  Rank Badge  -->
                    <Border
                      Grid.Column="2"
                      Padding="4,2"
                      VerticalAlignment="Top"
                      Background="#333333"
                      CornerRadius="4">
                      <TextBlock
                        FontSize="9"
                        FontWeight="Bold"
                        Foreground="{DynamicResource SecondaryTextBrush}"
                        Text="{Binding Rank}" />
                    </Border>
                  </Grid>

                  <!--  Price and Change  -->
                  <Grid Grid.Row="1" Margin="0,0,0,10">
                    <Grid.ColumnDefinitions>
                      <ColumnDefinition Width="*" />
                      <ColumnDefinition Width="Auto" />
                    </Grid.ColumnDefinitions>

                    <TextBlock
                      Grid.Column="0"
                      FontSize="18"
                      FontWeight="Bold"
                      Foreground="White"
                      Text="{Binding Price}" />

                    <!--  24h Change Badge  -->
                    <Border
                      Grid.Column="1"
                      Padding="6,3"
                      VerticalAlignment="Center"
                      CornerRadius="3">
                      <Border.Style>
                        <Style TargetType="Border">
                          <Style.Triggers>
                            <DataTrigger Binding="{Binding IsPositiveChange}" Value="True">
                              <Setter Property="Background" Value="#16a34a" />
                            </DataTrigger>
                            <DataTrigger Binding="{Binding IsPositiveChange}" Value="False">
                              <Setter Property="Background" Value="#dc2626" />
                            </DataTrigger>
                          </Style.Triggers>
                        </Style>
                      </Border.Style>
                      <TextBlock
                        FontSize="10"
                        FontWeight="Medium"
                        Foreground="White"
                        Text="{Binding Change24h}" />
                    </Border>
                  </Grid>

                  <!--  Market Stats  -->
                  <StackPanel Grid.Row="2">
                    <!--  Market Cap  -->
                    <Grid Margin="0,0,0,4">
                      <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="Auto" />
                      </Grid.ColumnDefinitions>
                      <TextBlock
                        Grid.Column="0"
                        FontSize="10"
                        Foreground="{DynamicResource SecondaryTextBrush}"
                        Text="Market Cap" />
                      <TextBlock
                        Grid.Column="1"
                        FontSize="10"
                        FontWeight="Medium"
                        Foreground="White"
                        Text="{Binding MarketCap}" />
                    </Grid>

                    <!--  Volume 24h  -->
                    <Grid>
                      <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="Auto" />
                      </Grid.ColumnDefinitions>
                      <TextBlock
                        Grid.Column="0"
                        FontSize="10"
                        Foreground="{DynamicResource SecondaryTextBrush}"
                        Text="Volume" />
                      <TextBlock
                        Grid.Column="1"
                        FontSize="10"
                        FontWeight="Medium"
                        Foreground="White"
                        Text="{Binding Volume24hFormatted}" />
                    </Grid>
                  </StackPanel>
                </Grid>
              </Border>
            </DataTemplate>
          </ItemsControl.ItemTemplate>
        </ItemsControl>
      </Grid>

      <!--  Pagination  -->
      <hc:Pagination
        Grid.Row="4"
        Margin="0,32,0,0"
        HorizontalAlignment="Center"
        MaxPageCount="{Binding TotalPages}"
        PageIndex="{Binding CurrentPage, Mode=TwoWay}" />

    </Grid>
  </ScrollViewer>
</UserControl>